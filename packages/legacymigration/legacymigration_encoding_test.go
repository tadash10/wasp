// Copyright 2020 IOTA Stiftung
// SPDX-License-Identifier: Apache-2.0
package legacymigration

import (
	"os"
	"testing"

	"github.com/stretchr/testify/require"

	"github.com/iotaledger/iota.go/bundle"
	"github.com/iotaledger/iota.go/transaction"
	iotago "github.com/iotaledger/iota.go/v3"
)

func TestLegacyFuncs(t *testing.T) {
	// taken from https://explorer.iota.org/legacy-mainnet/transaction/UAXHEGENCKOFNNWMWKDQDYJMFJVEL9PUYJVFSZODOUVTKXKBKWHMRNSUOQ9QBMONSSJHNUORHYHZ99999
	rawTrytes := []string{
		"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999TRANSFERNEGYZXAZKAPBOWHAVXHDWAJDYWOZWAMZODFBUBGCQEQ9XWCDUDBDFZXDTBGADXTWMDSDOEZD9NBQWWHA99999999999999999999WF99999999999999999999999999ZOQMFD99999999999C99999999APKIUYNXZLRLYCUYJRGTFTSYLCYJYEDCYJAFZOIRTYLLJNUOOJSGKPXLGKWADLHZICOUJXXLHEJSHYJHCMMKBXTDRTVMXNEIAYJCUMNCGKNQVSEUPKCZGJACCJ9AFFGVCGQXGSCKKOUBQQBJDXLMOMMVEZKRYZ99999V9PJWPAOYWURYYKGZZDBELYBWTXCFIVLJMUDSWWKFQQYTXFPNVJSCKBMDZRRRGBSYTQSWQDAGNZZ9999WF9999999999999999999999999QDJYGNAVF999999999MMMMMMMMMWVCLW9HGRAWJTEHKEBLBXTZCUXR",
		"QNABYZVQFZZWAAQKJIPNRWIRZJBOWMSLO9ROXXBEDNBBQRABWOBYI9BFXOU9YUS9CPAWRVKATGVUWUXTAMTRUMNR9BBCMYCPISYHWDOWCPROBZMYGUET9RRYVIOLXILTZNYMNAWXHDDIAGKMKLUDRSTGCTUBVDVPVDWYDKRWJPGTTZDAPVESCYBGGFORFDYYCUKWFKXQAWYZNWFYDIV9QMHGVNPVFRXBZFAFBVXWNEAYLEBNFN9PXRJQXAOGINGMFCKMPLMRDOWUZLLGEDVWVEIFFLNVITHGJXWKZE9QMPCRNUSZZBMQO9HK9DORTCNEIIECMTRQMAZKJFTFAJMXWBAGJ9LVWN9EYBZZTZZVPTLDRAIRZERLMKCVCSOMXTPFQOYJKCPQLPOUTYMEQENUCKJAZHJIJXGGBVEJQRZRRQWPSQ9JZPAEMESOZXKSNQJBLEDBCBZLTQVRDOJFGYHNGIYRVPATVRH9FLOGXWJTLWNDYABIDGFPFYYJFOKUKNOYCBOBTNHCCNHFCCKRFWPTFIEOESTTS9LXF9ABMLDJOZODMTLZZHKHTMCTVBGLOSHNUQ9TZKIEAX9AUMPHPSLDH99PCVWJSEGVKGSYMQWEKJCJBLGCRREHVTJETZEEODPZUMPALJEDRFNLITDLIXBDWDOL9OUXRLRZJYRHZIGGUGJZNWRIOFHTWXTMOMYQJBNKMNCTDPDKHYJNGBECRTPZAT999AYBMRM9VEOEIVZKRLHDVLREIIXXJYNMQYWTO9RSXSXOMCU9HYHZTZHGQOIFTNRQLLUPKWKGRUTOAPJSQAOVRAHGZJKHEAINBKSDDYARNALDVMILHYVPTOHCFVKECUIBMW99ILZGBOVURYKYVJBLGMRWIKSUTNBA9X9WMRZUZHDCWQKLTJBSBVLOZQFJDCYGZHNNITJLTDNSAVLAOO9KYBVQV9AQNJUQKPGCWBPVPVUETECYHMTDQRNUERA9WUXUXUUCAFQEANCOJCJWDHEDZPMMTTJXHPPNHMMJGXCACBZKSQXPLWYIDNHG9DEMFOC9WWYB9TCXMGLG9IAGYMLZDXIEMGACFVLGAXPBWULUHCHDZBDLVUBLTVGDEC9XOEGZTAYVAIJQ9EEYDBI9YSDZ9XNXOUDAU9XXLUUFXSXLHOTSCFMHEFABMK9XBZDCRSJMYEVIPSBKEALFXBQPFD9GGQJIOEKCQHFDZAOWJYWEWEFANXKFIQTNYBZBCQSKL9UMBDJQRHGAIMNLPLWHBPQOCMDLGRXELHW9ERUDI9SNQ9GWGTIFIOXZALQXRNVBVXDSJORLXMRRIAVWNMIAALDYRCVGPYZNYPQZOMIBM9FXCUUULTYIB9JOZR9UMEIGNER9XWO9IQLADAYHPJCDQTCWPCJNZHKPBOWNDPFFMDNIVWFBUUJMRQPZWFOXXF9EEMHEYUHNCBAJHWDIGWVXRTB9GOYUJWDRS9MILSQDQVZUKYVNUZUHZOJEGRZUGNZFPVZKDFCKAW9KNWNSHEWBQXITKKJWQAQYBUQEZKSFSOQBCVDSOGVAIHXLKUNGOMJVVRXXPCBLOILTIEQDWAGTPQWVNQNQMSNGFAQZVXHZIJFEGIFK9YOTSSGPZDAUUNQYKLFMMXPJZKUKTRBZZZP9JWTDRZTKNSJWEWOTORWTYSGOUNRLRIBPQIKZBSMILWPYEWNCGGOA9DAEDUEMYUHAFWB9XCZGILTQAPSNIFAWZSFHQFEPFGGRHUIZHZEXFHTUTY9UKGYDY9QHISNYBZFYSRHCCXVUMFLVMAJWYXUDGOSKXHCP9KKBMFJOCV9CTUQMBCW9FL9AXMABWPFYQDRYCAIPXLNJCWNKXDB9ZVKYRGVXQKGIRBAJB9XTDEKKEDGYCKLJOSJIIVSVOLDHISUSOJ9VIJLNWIOZCDBPNSJTFPJHCNLCGPWHJFQXEIRPUHLPF9JZKHMMPYJMWPVTSSGBABDXUPGDVDHVFPGOBTDTURWQTWTEKBFJLCXGESOWXRQPCTQYQBB9RQJUVYRXVMGNXOUIGMFDWBDEWKRMPOWZYGGYMLODKKXHLEUVBXKERAAHQYEYDIKYVABMO9KUJIARSEEUXTI9LBQLDCUFNDPZNWUSRWEE9KTQOXSNMCDQNGRBOZC9VVWWEEQAVFJYJPCPCYROCVE9WGHW9OSPFUKWDJXPXNMEHCKPOYBFWIURWEIEMAGWWPXVWDTMVUZVNYNYFOB9S9WIGHRNYVZBJEBBWQZIBWYIOZLKPGVNNCOLDIIUNNEQZYBDMYJDDSZ999999999999999999999999999999999999999999999999ZOQMFD99A99999999C99999999APKIUYNXZLRLYCUYJRGTFTSYLCYJYEDCYJAFZOIRTYLLJNUOOJSGKPXLGKWADLHZICOUJXXLHEJSHYJHCDJQNKMKBCABQASYTQCCBXLOMXXBHKQEQFLSYA9LBALUKPZPDZCXGMTAJZCHQVPNCQVJPMCRI9STF999999V9PJWPAOYWURYYKGZZDBELYBWTXCFIVLJMUDSWWKFQQYTXFPNVJSCKBMDZRRRGBSYTQSWQDAGNZZ9999999999999999999999999999999CVCXGNAVF999999999MMMMMMMMMPXUWJKPOHBMBDNZYWXEGGSEHGAK",
		"AAPQEIUASRNMDUIUIADDXTMZ9PZJDCCHMTSFQIRYNGCUABRFDIILYQNBLTJNZHALKF9OFJGYTTDVKIQADREXTTPLAVDYSACOMNHTLXMUQPLTWMKOJAL9PZKVVGSDULFVNJMRBHGGEGWDAPBJCLSCFJCMFGTXDBFMPBDFLULKVCPIYLBEYWHIKPOFNQUMCLIELTVRVISYIM9LJPTQXGZQTEKQPLWXKYMIOHISGGTKQUKICOKTEKDRFVNIMNVRSUQHIAOAVXLJKTDQTHLMCZLOZCZRJOTSAVRPRIJCV9ETFI9DSLDR9BVJDEXFVOJUCQLI9JZDO9FP9TRN9MTGET9RIPNTASM9AINXMLITAZOIAMFDZFVWBCUXWBZLNGTLM9CHHKVIZLUPWGUKFGNTBJHBCPDXFRKJHRGBGHMAOPRAAJUALPFKFEIUPKAHFB9PVTKITR9J9RES9HDQLNVQBYMZZBBSRKEUSKDNHXVWKYWPRGTYFSWVALINKDSSQCSU9NVSRF9YTODXOOGNBZYUEVCYMKBWVAULDICZKUNTQSWHGQ9FMAZMIQZPGLDDHTOMDNSGRHZIS9VRU9JPVL9HZO9XRNXH9KQIFAJOQYCRNNYBRUUIVOXMPZXRECBWFIZKIJVOKJYWCXQXTYNRLV9HSYQMKGEYLTUAHPMPWJBTGMHRUIRRMNQWMQYBOAKGJBNFJMDLSUYGFADJTLLUMHJDFKLJGRBTXFAXLMXWICKUWCKCNCXEUWQTUX9KBBINVFYKXBTSHGPLTCBTRGPZGJGCFYJICNPPZLXRWKHRGVHUOWDIODHEVLOJGBKMOCTPUTKGMNSTCTRW9RDQ9RUPSPYQSIZR9GHQUMRNVI9JOLSJHXXUMHKXV9JBE9OQOEXAKZWYIHRMAV9ZPIHFTHNZCTQKVDSRBXEMAJPTASTTLBBQGIKPQUOYXWKWGHGUNKEEZCCBYXECQKCUWGXTROWWWQPOUT99HBOCQWQEMINGIW9KRQDDYXFMSPJOACFUJAFRQWHCNUG9OBWWPKLBFJ9IRAMSAEWEAU9FCJJWX9NSMHUZQNRPDDSXGSTVCGNDWKJARLDJ9NYDCAXLCXHIWWAYEEUIOLQHGIUIWPYBP9QHEDERBACOZTIOKWZMZDNKXQVPBTJJB9PESPPBHVVGIWBLJPMNZL9ZLSXRWCYZDYUQQB9BTGUHYMGJSVJSLXDOJ9IPIPSTJRXDK9XFADXJCIXCXFHGRLUCRSBTWTTOWJDKBOXNYREKLIJULBTCKIFJG9QKUCWYRGC9KNOSYY9D9XLRVOLZ9VOWKVUJVUMNOQJUBCOAQZTACUAASLXUBVCXFWZFXJZLYDCNQVARIWYZRRVS9RWKJHYSRKWXIUNLPWJWYYQEMQAAUKTRXUSKXCPZNMNLI9BEQJAPAWDNCMOAVNIGQMTMCGHBHXJZLBMTVFARBUNFPDJPFYBGFRGJDYLQNMTYHIUZAVEYBSHLOXZ9MDHADDM9F9CKTJPGBZMMNEV9YKGLNYJQRS9PUSXIVWJIUADNFZBBBML9ONXFSAC9MJSGYAQKICRWP9LBGPQKZPPLACTYUMVAFSKWCEB9YAZUKAW9RWZOGAVFRXYZHUE9FPZXDRXCHPGWWUYLQTORQ9AEQMPHLEDQPJVLKWNUSMGZAOR9OIMGAUMFMNGXIZTDEP9FFLFSLJCNUAXHETXT9CLIJG9CWNJVGWZ9UYATOFASOIOCLAYVMSDJINXIHLFCMOQWJFILYWCKSGEOJKIBK9KDFEGRMTPEOBODFVMGSLAZXCBQLNPZIEKTADJYOZGXHBQWDQQYOFMJAKHUFTHWQNKSJKOCRRVMMWEVKSWTDRNCLJAMPIOOUZFKNRMJLIBKSEEQJQQ9RMDMHM9HWWHFOBDFNDANP9GYLORLPAHDQNIMKDMUARFCQEFNBJ9HHPLVBZNWBWETUYLRQHO9QUQXZTJHDVNRSMHWXOJNEJABLEOZCDCSFWLIWM9YBLDXCRNQUGOIDQQJLQSQDXVAIYBCVLXHUJDMZHMEBDIOLWFIEREKFMTLMENROGNMGZUQTQYLVLFSSLEO9JJT9MGUKKVCUZLCVEBMKIPYWAOJRHDJPMXORQXUD9HWNTOISQRQOMVKBDLDKDQICHFUTHIR9QTUOGLBXLROITQWMBEVUOADSANQTDXIRLQ9ARVAYEEGCYYKAUDFWIURWEIEMAGWWPXVWDTMVUZVNYNYFOB9S9WIGHRNYVZBJEBBWQZIBWYIOZLKPGVNNCOLDIIUNNEQZYBD9999999999999999999999999999999999999999999999999999999ZOQMFD99B99999999C99999999APKIUYNXZLRLYCUYJRGTFTSYLCYJYEDCYJAFZOIRTYLLJNUOOJSGKPXLGKWADLHZICOUJXXLHEJSHYJHCLSEIINLCTNVHBJEQEZCFTJBJMTI9OJTJIIFXMUDNXZBOQAJIMQQDWTTWKFJKLDLUFBCVXOGRJIAWA99999V9PJWPAOYWURYYKGZZDBELYBWTXCFIVLJMUDSWWKFQQYTXFPNVJSCKBMDZRRRGBSYTQSWQDAGNZZ9999999999999999999999999999999NGSXGNAVF999999999MMMMMMMMMZVOOETQIXXKTH9VISSPGETBLUTY",
		"WIJFPCX9BPLELNLCJRPSMXNPLQRYEJFTNBWLNQAJUMICHQAHZYMKWDMSCPZXEZVKMQGZPWQJDQSFNKESXQZHW9HWZUVZAWNHFZTMIDLAWNNPHYOJQUBZNYGFYFRTBMKPXKGNRJGUDULEO9EHSQMPARGCSXVLIRJEWWH9BELGRUQVMHMKSRECL9PXAFJ9JQOGWHNILROQLO9UVYUEFWJLMLMHIUUBZPDAPFDV9JPEPTEWVIAUZOYN9VDDIU9OMVZAWNOGCUJTXXGTPYXRQBDRIMF9NVFBWMKXNGLCXHQEOTJVJQNROTRGTKEHTUKCZBVSHREYWLHPSYUKJXOXMXEBNDIGLJAPKEXVMNFG9SXPUXOPDIGDSQJOALVTK9SLDDKPNAJBQCLEHRMKIDJJXQYZDDJLRUPJWPVZUQNIMDDMLBK9XYXHQZPJRFYIWTPDRYOEBTKIENEIIUGGYVKPUSABQDFJYNSOLHVCPJCITWCUYQBA9B9LNPLKQLPX9A9GAJWQSMJOJPWABUUQF9FVIOAAFIQIBXFIFBFPUACES9YHLAWPUCGMCYPSLK9ITKGDMHRJTIDVMPRQVMPNAJBV9VHJANGMIZDUJQSHAMBNWHJOG9ZURWJSTCKCQVHIYJFGDX9KIWUDGTFAZYGVALVLG9SDWNFMQ9YGKLPWNHZNWUKXUEFTEBZ9DZ9PPAKCDNSBMAICYGSHJZSOGKCWTQTOPTPYPDHQBWAJUDZJXKUO9MQPHAUKIIGYVDRSPVXYABDZJEIUVZKDR9SEACCPYFSFPVVMSVZZWMBUNAPEAIPNHANERACY9ERGHQXBSFIGYORXCIBLBTYVMSZ9IHQGRDSHXKRTZWASOXFGIGGLDKYAVWKGLIIDFDLMPZZDWWHWRSDGRHRSWOBYNRMSYGAGENVITEP9XTCVUXNDO9AQZGWLFVJQXIKGWZG9BYWKPQVHSMZFIGKSHGITHXSVJEDWEYTDIOGHEIINMPLWNZYHIKQVBRQGYFIMIF9DPVJLVJLVKGZGMT9P9U9OJDONSPMZXNMQLBCQB9VEKEKLZGWPGLPUH9KIHBEEAFRHBXZJJQLNSNMWVLWQQTYEROVTYIAEBYTQYBLFPCPFEVBIKHXRMOWJSHVUIQPAODHKMQYHBPPYFDVLODULIHSAIVHRAJQNMVYRVGXAWCY9IDAKWE9HYGKUQPBCCAAHBBGMUVZWNFIHAVIWWJYZLXPYNYUPNRRTHVMVBJCRSIRAOKGJSLOWLYGG9DAJPWQSYDUTWKKJFYVTQKN9ZNJFBHLWWK9FAOXCJZCZQDUYSHDWKWEYJYYRT9TDPOECSGWVCEXQXXIAZTBUXZWEKSGZ9ZFVKUVXPUIBVYVFCTIEBTTAQNTJZKNJ9WKVWYBHSGJNSLEFKMMJJQ9MGDUWLYEALLYGOEMQXHZITVJRILIZ99FVFYKXPEFCUWLIAAERTVNESWUYEBHELWVYPOAKFIQRPHYJOPYKTCPOYQXKXBJFDTKLGWTKXRSZQNVJURPCWQFYRUXBYYBAMRMBRKNQGZDEE9XQKNXOZXOCCNGMRMKTKQAGU9FWNRFVPETBZCQUUANZOQH9VUYY9GYDLKEJHGULOEDFUQPOOUWMYYRRNWDCTPQZYJIZFOZQMOGGHRZJOVJNLP9TZZ99SQYMKMJSGG9NPTIHLJUQIBEIWKOKENHQPNRWWECNQ9LLKVKGALVUGZCCTKJDPMAOZMUTPWUSVEHOPRPKQXE9FOT9MGYNQGKSYKSYLTBGLDN9QXEJMNXF9RCQRPPKQPWFVDRSANEEOFYLWGIBAW9SFTIVNJJRCQSPQSSPAYUAMGKIFLHSYJKNLLYUAFVVMHOSWFELDASAAPQNDYR9XGXSZQNCY9XCYLCMKHUKQGHTMQCFAYHGREJJCWHQZVOLUDMUPFFUJTIBJPUBOPBASHIFWOTNDTLTWPEIIFSWBMMKYR9WZSXZTRJZRLCSVGPJZHWAAKQJHEFZKB9MTFFAOXOUUADGOVWMB9MIQBEDFMFEXDZYWPDUVEBJBHUBVNYYXODBKDZHFIBVVUENTJQZXJVAIFCASYAWFFCRLCZLOPZNADEKGWDWFBAYYXQLOWHKHRQNFWMBLZCFAJNZXXNSAFKZUYEYFJVLHTZFFTWYWAJVBTTJ9MHVNDWCIENVGRM9AZ9VZNAOFPMWTWHAABRZTWFPEPXFWIURWEIEMAGWWPXVWDTMVUZVNYNYFOB9S9WIGHRNYVZBJEBBWQZIBWYIOZLKPGVNNCOLDIIUNNEQZYBD9999999999999999999999999999999999999999999999999999999ZOQMFD99C99999999C99999999APKIUYNXZLRLYCUYJRGTFTSYLCYJYEDCYJAFZOIRTYLLJNUOOJSGKPXLGKWADLHZICOUJXXLHEJSHYJHC9V9PJWPAOYWURYYKGZZDBELYBWTXCFIVLJMUDSWWKFQQYTXFPNVJSCKBMDZRRRGBSYTQSWQDAGNZZ9999VKBQRURURHEB9PXVIAGFNVB9LDZHCVHUZEUDQVMWSZIBQCSGBSVUFDUZBTJKCLUJIDNHDLYXFMWEA9999999999999999999999999999999CAMWGNAVF999999999MMMMMMMMMBNME9RGC9TEKIZHRGZYEJFLWHYS",
	}

	bndl, err := transaction.AsTransactionObjects(rawTrytes, nil)
	require.NoError(t, err)
	// validate the bundle, do migration checks
	err = bundle.ValidBundle(bndl, true)
	require.NoError(t, err)
}

func TestDecodeBundleFromWalletRS(t *testing.T) {
	// valid bundle encoded using walletES
	bundleHex, err := os.ReadFile("valid_bundle_example.hex")
	require.NoError(t, err)
	bundleBytes, err := iotago.DecodeHex(string(bundleHex))
	require.NoError(t, err)
	bndl, err := validBundleFromBytes(bundleBytes)
	require.NoError(t, err)

	err = bundle.ValidBundle(bndl, true)
	require.NoError(t, err)

	migratedAddresses, targetAddress, err := addressesFromBundle(bndl)
	require.NoError(t, err)
	require.Len(t, migratedAddresses, 1)
	require.EqualValues(t, "0x7ad1aee6262b8823aa74177692d917f2603c30587df6916f666eeb692f22b38d", targetAddress.String())
}
